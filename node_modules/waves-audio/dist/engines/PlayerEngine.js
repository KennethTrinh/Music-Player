'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _AudioTimeEngine2 = require('../core/AudioTimeEngine');

var _AudioTimeEngine3 = _interopRequireDefault(_AudioTimeEngine2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function optOrDef(opt, def) {
  if (opt !== undefined) return opt;

  return def;
}

/**
 * Used with a buffer to serve audio files.
 *
 * [example]{@link https://rawgit.com/wavesjs/waves-audio/master/examples/player-engine/index.html}
 *
 * @extends AudioTimeEngine
 * @example
 * import * as audio from 'waves-audio';
 * const playerEngine = audio.PlayerEngine();
 * const playControl = new audio.PlayControl(playerEngine);
 *
 * playControl.start();
 *
 * @param {Object} [options={}] - Default options
 * @param {Number} [options.buffer=1] - Audio buffer
 * @param {Number} [options.fadeTime=0.005] - Fade time for chaining segments
 * @param {Number} [options.cyclic=false] - Loop mode
 * @param {Number} [options.gain=1] - Gain
 */

var PlayerEngine = function (_AudioTimeEngine) {
  (0, _inherits3.default)(PlayerEngine, _AudioTimeEngine);

  function PlayerEngine() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    (0, _classCallCheck3.default)(this, PlayerEngine);

    var _this = (0, _possibleConstructorReturn3.default)(this, (PlayerEngine.__proto__ || (0, _getPrototypeOf2.default)(PlayerEngine)).call(this, options.audioContext));

    _this.transport = null; // set when added to transporter

    /**
     * Audio buffer
     *
     * @type {AudioBuffer}
     * @name buffer
     * @memberof PlayerEngine
     * @instance
     * @default null
     */
    _this.buffer = optOrDef(options.buffer, null);

    /**
     * Fade time for chaining segments (e.g. in start, stop, and seek)
     *
     * @type {Number}
     * @name fadeTime
     * @memberof PlayerEngine
     * @instance
     * @default 0.005
     */
    _this.fadeTime = optOrDef(options.fadeTime, 0.005);

    _this.__time = 0;
    _this.__position = 0;
    _this.__speed = 0;

    _this.__bufferSource = null;
    _this.__envNode = null;

    _this.__gainNode = _this.audioContext.createGain();
    _this.__gainNode.gain.value = optOrDef(options.gain, 1);

    _this.__cyclic = optOrDef(options.cyclic, false);

    _this.outputNode = _this.__gainNode;
    return _this;
  }

  (0, _createClass3.default)(PlayerEngine, [{
    key: '__start',
    value: function __start(time, position, speed) {
      var audioContext = this.audioContext;

      if (this.buffer) {
        var bufferDuration = this.buffer.duration;

        if (this.__cyclic && (position < 0 || position >= bufferDuration)) {
          var phase = position / bufferDuration;
          position = (phase - Math.floor(phase)) * bufferDuration;
        }

        if (position >= 0 && position < bufferDuration && speed > 0) {
          this.__envNode = audioContext.createGain();
          this.__envNode.gain.setValueAtTime(0, time);
          this.__envNode.gain.linearRampToValueAtTime(1, time + this.fadeTime);
          this.__envNode.connect(this.__gainNode);

          this.__bufferSource = audioContext.createBufferSource();
          this.__bufferSource.buffer = this.buffer;
          this.__bufferSource.playbackRate.value = speed;
          this.__bufferSource.loop = this.__cyclic;
          this.__bufferSource.loopStart = 0;
          this.__bufferSource.loopEnd = bufferDuration;
          this.__bufferSource.start(time, position);
          this.__bufferSource.connect(this.__envNode);
        }
      }
    }
  }, {
    key: '__halt',
    value: function __halt(time) {
      if (this.__bufferSource) {
        this.__envNode.gain.cancelScheduledValues(time);
        this.__envNode.gain.setValueAtTime(this.__envNode.gain.value, time);
        this.__envNode.gain.linearRampToValueAtTime(0, time + this.fadeTime);
        this.__bufferSource.stop(time + this.fadeTime);

        this.__bufferSource = null;
        this.__envNode = null;
      }
    }

    // TimeEngine method (speed-controlled interface)

  }, {
    key: 'syncSpeed',
    value: function syncSpeed(time, position, speed) {
      var seek = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;

      var lastSpeed = this.__speed;

      if (speed !== lastSpeed || seek) {
        if (seek || lastSpeed * speed < 0) {
          this.__halt(time);
          this.__start(time, position, speed);
        } else if (lastSpeed === 0 || seek) {
          this.__start(time, position, speed);
        } else if (speed === 0) {
          this.__halt(time);
        } else if (this.__bufferSource) {
          this.__bufferSource.playbackRate.setValueAtTime(speed, time);
        }

        this.__speed = speed;
      }
    }

    /**
     * Set whether the audio buffer is considered as cyclic
     * @type {Bool}
     * @name cyclic
     * @memberof PlayerEngine
     * @instance
     */

  }, {
    key: 'cyclic',
    set: function set(cyclic) {
      if (cyclic !== this.__cyclic) {
        var time = this.currentTime;
        var position = this.currentosition;

        this.__halt(time);
        this.__cyclic = cyclic;

        if (this.__speed !== 0) this.__start(time, position, this.__speed);
      }
    },
    get: function get() {
      return this.__cyclic;
    }

    /**
     * Linear gain factor
     * @type {Number}
     * @name gain
     * @memberof PlayerEngine
     * @instance
     */

  }, {
    key: 'gain',
    set: function set(value) {
      var time = this.currentTime;
      this.__gainNode.gain.cancelScheduledValues(time);
      this.__gainNode.gain.setValueAtTime(this.__gainNode.gain.value, time);
      this.__gainNode.gain.linearRampToValueAtTime(0, time + this.fadeTime);
    },
    get: function get() {
      return this.__gainNode.gain.value;
    }

    /**
     * Get buffer duration
     * @type {Number}
     * @name bufferDuration
     * @memberof PlayerEngine
     * @instance
     * @readonly
     */

  }, {
    key: 'bufferDuration',
    get: function get() {
      if (this.buffer) return this.buffer.duration;

      return 0;
    }
  }]);
  return PlayerEngine;
}(_AudioTimeEngine3.default);

exports.default = PlayerEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlBsYXllckVuZ2luZS5qcyJdLCJuYW1lcyI6WyJvcHRPckRlZiIsIm9wdCIsImRlZiIsInVuZGVmaW5lZCIsIlBsYXllckVuZ2luZSIsIm9wdGlvbnMiLCJhdWRpb0NvbnRleHQiLCJ0cmFuc3BvcnQiLCJidWZmZXIiLCJmYWRlVGltZSIsIl9fdGltZSIsIl9fcG9zaXRpb24iLCJfX3NwZWVkIiwiX19idWZmZXJTb3VyY2UiLCJfX2Vudk5vZGUiLCJfX2dhaW5Ob2RlIiwiY3JlYXRlR2FpbiIsImdhaW4iLCJ2YWx1ZSIsIl9fY3ljbGljIiwiY3ljbGljIiwib3V0cHV0Tm9kZSIsInRpbWUiLCJwb3NpdGlvbiIsInNwZWVkIiwiYnVmZmVyRHVyYXRpb24iLCJkdXJhdGlvbiIsInBoYXNlIiwiTWF0aCIsImZsb29yIiwic2V0VmFsdWVBdFRpbWUiLCJsaW5lYXJSYW1wVG9WYWx1ZUF0VGltZSIsImNvbm5lY3QiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJwbGF5YmFja1JhdGUiLCJsb29wIiwibG9vcFN0YXJ0IiwibG9vcEVuZCIsInN0YXJ0IiwiY2FuY2VsU2NoZWR1bGVkVmFsdWVzIiwic3RvcCIsInNlZWsiLCJsYXN0U3BlZWQiLCJfX2hhbHQiLCJfX3N0YXJ0IiwiY3VycmVudFRpbWUiLCJjdXJyZW50b3NpdGlvbiIsIkF1ZGlvVGltZUVuZ2luZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7O0FBRUEsU0FBU0EsUUFBVCxDQUFrQkMsR0FBbEIsRUFBdUJDLEdBQXZCLEVBQTRCO0FBQzFCLE1BQUdELFFBQVFFLFNBQVgsRUFDRSxPQUFPRixHQUFQOztBQUVGLFNBQU9DLEdBQVA7QUFDRDs7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFtQk1FLFk7OztBQUNKLDBCQUEwQjtBQUFBLFFBQWRDLE9BQWMsdUVBQUosRUFBSTtBQUFBOztBQUFBLGtKQUNsQkEsUUFBUUMsWUFEVTs7QUFHeEIsVUFBS0MsU0FBTCxHQUFp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Q0EsYUFBS0gsUUFBTCxHQUFnQkMsTUFBaEI7O0FBRUEsWUFBSSxLQUFLUixPQUFMLEtBQWlCLENBQXJCLEVBQ0UsS0FBS2dDLE9BQUwsQ0FBYXRCLElBQWIsRUFBbUJDLFFBQW5CLEVBQTZCLEtBQUtYLE9BQWxDO0FBQ0g7QUFDRixLO3dCQUVZO0FBQ1gsYUFBTyxLQUFLTyxRQUFaO0FBQ0Q7O0FBRUQ7Ozs7Ozs7Ozs7c0JBT1NELEssRUFBTztBQUNkLFVBQUlJLE9BQU8sS0FBS3VCLFdBQWhCO0FBQ0EsV0FBSzlCLFVBQUwsQ0FBZ0JFLElBQWhCLENBQXFCc0IscUJBQXJCLENBQTJDakIsSUFBM0M7QUFDQSxXQUFLUCxVQUFMLENBQWdCRSxJQUFoQixDQUFxQmEsY0FBckIsQ0FBb0MsS0FBS2YsVUFBTCxDQUFnQkUsSUFBaEIsQ0FBcUJDLEtBQXpELEVBQWdFSSxJQUFoRTtBQUNBLFdBQUtQLFVBQUwsQ0FBZ0JFLElBQWhCLENBQXFCYyx1QkFBckIsQ0FBNkMsQ0FBN0MsRUFBZ0RULE9BQU8sS0FBS2IsUUFBNUQ7QUFDRCxLO3dCQUVVO0FBQ1QsYUFBTyxLQUFLTSxVQUFMLENBQWdCRSxJQUFoQixDQUFxQkMsS0FBNUI7QUFDRDs7QUFFRDs7Ozs7Ozs7Ozs7d0JBUXFCO0FBQ25CLFVBQUcsS0FBS1YsTUFBUixFQUNFLE9BQU8sS0FBS0EsTUFBTCxDQUFZa0IsUUFBbkI7O0FBRUYsYUFBTyxDQUFQO0FBQ0Q7OztFQS9Kd0JxQix5Qjs7a0JBa0taM0MsWSIsImZpbGUiOiJQbGF5ZXJFbmdpbmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQXVkaW9UaW1lRW5naW5lIGZyb20gJy4uL2NvcmUvQXVkaW9UaW1lRW5naW5lJztcblxuZnVuY3Rpb24gb3B0T3JEZWYob3B0LCBkZWYpIHtcbiAgaWYob3B0ICE9PSB1bmRlZmluZWQpXG4gICAgcmV0dXJuIG9wdDtcblxuICByZXR1cm4gZGVmO1xufVxuXG4vKipcbiAqIFVzZWQgd2l0aCBhIGJ1ZmZlciB0byBzZXJ2ZSBhdWRpbyBmaWxlcy5cbiAqXG4gKiBbZXhhbXBsZV17QGxpbmsgaHR0cHM6Ly9yYXdnaXQuY29tL3dhdmVzanMvd2F2ZXMtYXVkaW8vbWFzdGVyL2V4YW1wbGVzL3BsYXllci1lbmdpbmUvaW5kZXguaHRtbH1cbiAqXG4gKiBAZXh0ZW5kcyBBdWRpb1RpbWVFbmdpbmVcbiAqIEBleGFtcGxlXG4gKiBpbXBvcnQgKiBhcyBhdWRpbyBmcm9tICd3YXZlcy1hdWRpbyc7XG4gKiBjb25zdCBwbGF5ZXJFbmdpbmUgPSBhdWRpby5QbGF5ZXJFbmdpbmUoKTtcbiAqIGNvbnN0IHBsYXlDb250cm9sID0gbmV3IGF1ZGlvLlBsYXlDb250cm9sKHBsYXllckVuZ2luZSk7XG4gKlxuICogcGxheUNvbnRyb2wuc3RhcnQoKTtcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dIC0gRGVmYXVsdCBvcHRpb25zXG4gKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMuYnVmZmVyPTFdIC0gQXVkaW8gYnVmZmVyXG4gKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMuZmFkZVRpbWU9MC4wMDVdIC0gRmFkZSB0aW1lIGZvciBjaGFpbmluZyBzZWdtZW50c1xuICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLmN5Y2xpYz1mYWxzZV0gLSBMb29wIG1vZGVcbiAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5nYWluPTFdIC0gR2FpblxuICovXG5jbGFzcyBQbGF5ZXJFbmdpbmUgZXh0ZW5kcyBBdWRpb1RpbWVFbmdpbmUge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICBzdXBlcihvcHRpb25zLmF1ZGlvQ29udGV4dCk7XG5cbiAgICB0aGlzLnRyYW5zcG9ydCA9IG51bGw7IC8vIHNldCB3aGVuIGFkZGVkIHRvIHRyYW5zcG9ydGVyXG5cbiAgICAvKipcbiAgICAgKiBBdWRpbyBidWZmZXJcbiAgICAgKlxuICAgICAqIEB0eXBlIHtBdWRpb0J1ZmZlcn1cbiAgICAgKiBAbmFtZSBidWZmZXJcbiAgICAgKiBAbWVtYmVyb2YgUGxheWVyRW5naW5lXG4gICAgICogQGluc3RhbmNlXG4gICAgICogQGRlZmF1bHQgbnVsbFxuICAgICAqL1xuICAgIHRoaXMuYnVmZmVyID0gb3B0T3JEZWYob3B0aW9ucy5idWZmZXIsIG51bGwpO1xuXG4gICAgLyoqXG4gICAgICogRmFkZSB0aW1lIGZvciBjaGFpbmluZyBzZWdtZW50cyAoZS5nLiBpbiBzdGFydCwgc3RvcCwgYW5kIHNlZWspXG4gICAgICpcbiAgICAgKiBAdHlwZSB7TnVtYmVyfVxuICAgICAqIEBuYW1lIGZhZGVUaW1lXG4gICAgICogQG1lbWJlcm9mIFBsYXllckVuZ2luZVxuICAgICAqIEBpbnN0YW5jZVxuICAgICAqIEBkZWZhdWx0IDAuMDA1XG4gICAgICovXG4gICAgdGhpcy5mYWRlVGltZSA9IG9wdE9yRGVmKG9wdGlvbnMuZmFkZVRpbWUsIDAuMDA1KTtcblxuICAgIHRoaXMuX190aW1lID0gMDtcbiAgICB0aGlzLl9fcG9zaXRpb24gPSAwO1xuICAgIHRoaXMuX19zcGVlZCA9IDA7XG5cbiAgICB0aGlzLl9fYnVmZmVyU291cmNlID0gbnVsbDtcbiAgICB0aGlzLl9fZW52Tm9kZSA9IG51bGw7XG5cbiAgICB0aGlzLl9fZ2Fpbk5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVHYWluKCk7XG4gICAgdGhpcy5fX2dhaW5Ob2RlLmdhaW4udmFsdWUgPSBvcHRPckRlZihvcHRpb25zLmdhaW4sIDEpO1xuXG4gICAgdGhpcy5fX2N5Y2xpYyA9IG9wdE9yRGVmKG9wdGlvbnMuY3ljbGljLCBmYWxzZSk7XG5cbiAgICB0aGlzLm91dHB1dE5vZGUgPSB0aGlzLl9fZ2Fpbk5vZGU7XG4gIH1cblxuICBfX3N0YXJ0KHRpbWUsIHBvc2l0aW9uLCBzcGVlZCkge1xuICAgIHZhciBhdWRpb0NvbnRleHQgPSB0aGlzLmF1ZGlvQ29udGV4dDtcblxuICAgIGlmICh0aGlzLmJ1ZmZlcikge1xuICAgICAgdmFyIGJ1ZmZlckR1cmF0aW9uID0gdGhpcy5idWZmZXIuZHVyYXRpb247XG5cbiAgICAgIGlmICh0aGlzLl9fY3ljbGljICYmIChwb3NpdGlvbiA8IDAgfHwgcG9zaXRpb24gPj0gYnVmZmVyRHVyYXRpb24pKSB7XG4gICAgICAgIHZhciBwaGFzZSA9IHBvc2l0aW9uIC8gYnVmZmVyRHVyYXRpb247XG4gICAgICAgIHBvc2l0aW9uID0gKHBoYXNlIC0gTWF0aC5mbG9vcihwaGFzZSkpICogYnVmZmVyRHVyYXRpb247XG4gICAgICB9XG5cbiAgICAgIGlmIChwb3NpdGlvbiA+PSAwICYmIHBvc2l0aW9uIDwgYnVmZmVyRHVyYXRpb24gJiYgc3BlZWQgPiAwKSB7XG4gICAgICAgIHRoaXMuX19lbnZOb2RlID0gYXVkaW9Db250ZXh0LmNyZWF0ZUdhaW4oKTtcbiAgICAgICAgdGhpcy5fX2Vudk5vZGUuZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLCB0aW1lKTtcbiAgICAgICAgdGhpcy5fX2Vudk5vZGUuZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgxLCB0aW1lICsgdGhpcy5mYWRlVGltZSk7XG4gICAgICAgIHRoaXMuX19lbnZOb2RlLmNvbm5lY3QodGhpcy5fX2dhaW5Ob2RlKTtcblxuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlID0gYXVkaW9Db250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLmJ1ZmZlciA9IHRoaXMuYnVmZmVyO1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLnBsYXliYWNrUmF0ZS52YWx1ZSA9IHNwZWVkO1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLmxvb3AgPSB0aGlzLl9fY3ljbGljO1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLmxvb3BTdGFydCA9IDA7XG4gICAgICAgIHRoaXMuX19idWZmZXJTb3VyY2UubG9vcEVuZCA9IGJ1ZmZlckR1cmF0aW9uO1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLnN0YXJ0KHRpbWUsIHBvc2l0aW9uKTtcbiAgICAgICAgdGhpcy5fX2J1ZmZlclNvdXJjZS5jb25uZWN0KHRoaXMuX19lbnZOb2RlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfX2hhbHQodGltZSkge1xuICAgIGlmICh0aGlzLl9fYnVmZmVyU291cmNlKSB7XG4gICAgICB0aGlzLl9fZW52Tm9kZS5nYWluLmNhbmNlbFNjaGVkdWxlZFZhbHVlcyh0aW1lKTtcbiAgICAgIHRoaXMuX19lbnZOb2RlLmdhaW4uc2V0VmFsdWVBdFRpbWUodGhpcy5fX2Vudk5vZGUuZ2Fpbi52YWx1ZSwgdGltZSk7XG4gICAgICB0aGlzLl9fZW52Tm9kZS5nYWluLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKDAsIHRpbWUgKyB0aGlzLmZhZGVUaW1lKTtcbiAgICAgIHRoaXMuX19idWZmZXJTb3VyY2Uuc3RvcCh0aW1lICsgdGhpcy5mYWRlVGltZSk7XG5cbiAgICAgIHRoaXMuX19idWZmZXJTb3VyY2UgPSBudWxsO1xuICAgICAgdGhpcy5fX2Vudk5vZGUgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRpbWVFbmdpbmUgbWV0aG9kIChzcGVlZC1jb250cm9sbGVkIGludGVyZmFjZSlcbiAgc3luY1NwZWVkKHRpbWUsIHBvc2l0aW9uLCBzcGVlZCwgc2VlayA9IGZhbHNlKSB7XG4gICAgdmFyIGxhc3RTcGVlZCA9IHRoaXMuX19zcGVlZDtcblxuICAgIGlmIChzcGVlZCAhPT0gbGFzdFNwZWVkIHx8IHNlZWspIHtcbiAgICAgIGlmIChzZWVrIHx8IGxhc3RTcGVlZCAqIHNwZWVkIDwgMCkge1xuICAgICAgICB0aGlzLl9faGFsdCh0aW1lKTtcbiAgICAgICAgdGhpcy5fX3N0YXJ0KHRpbWUsIHBvc2l0aW9uLCBzcGVlZCk7XG4gICAgICB9IGVsc2UgaWYgKGxhc3RTcGVlZCA9PT0gMCB8fCBzZWVrKSB7XG4gICAgICAgIHRoaXMuX19zdGFydCh0aW1lLCBwb3NpdGlvbiwgc3BlZWQpO1xuICAgICAgfSBlbHNlIGlmIChzcGVlZCA9PT0gMCkge1xuICAgICAgICB0aGlzLl9faGFsdCh0aW1lKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5fX2J1ZmZlclNvdXJjZSkge1xuICAgICAgICB0aGlzLl9fYnVmZmVyU291cmNlLnBsYXliYWNrUmF0ZS5zZXRWYWx1ZUF0VGltZShzcGVlZCwgdGltZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX19zcGVlZCA9IHNwZWVkO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgd2hldGhlciB0aGUgYXVkaW8gYnVmZmVyIGlzIGNvbnNpZGVyZWQgYXMgY3ljbGljXG4gICAqIEB0eXBlIHtCb29sfVxuICAgKiBAbmFtZSBjeWNsaWNcbiAgICogQG1lbWJlcm9mIFBsYXllckVuZ2luZVxuICAgKiBAaW5zdGFuY2VcbiAgICovXG4gIHNldCBjeWNsaWMoY3ljbGljKSB7XG4gICAgaWYgKGN5Y2xpYyAhPT0gdGhpcy5fX2N5Y2xpYykge1xuICAgICAgdmFyIHRpbWUgPSB0aGlzLmN1cnJlbnRUaW1lO1xuICAgICAgdmFyIHBvc2l0aW9uID0gdGhpcy5jdXJyZW50b3NpdGlvbjtcblxuICAgICAgdGhpcy5fX2hhbHQodGltZSk7XG4gICAgICB0aGlzLl9fY3ljbGljID0gY3ljbGljO1xuXG4gICAgICBpZiAodGhpcy5fX3NwZWVkICE9PSAwKVxuICAgICAgICB0aGlzLl9fc3RhcnQodGltZSwgcG9zaXRpb24sIHRoaXMuX19zcGVlZCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGN5Y2xpYygpIHtcbiAgICByZXR1cm4gdGhpcy5fX2N5Y2xpYztcbiAgfVxuXG4gIC8qKlxuICAgKiBMaW5lYXIgZ2FpbiBmYWN0b3JcbiAgICogQHR5cGUge051bWJlcn1cbiAgICogQG5hbWUgZ2FpblxuICAgKiBAbWVtYmVyb2YgUGxheWVyRW5naW5lXG4gICAqIEBpbnN0YW5jZVxuICAgKi9cbiAgc2V0IGdhaW4odmFsdWUpIHtcbiAgICB2YXIgdGltZSA9IHRoaXMuY3VycmVudFRpbWU7XG4gICAgdGhpcy5fX2dhaW5Ob2RlLmdhaW4uY2FuY2VsU2NoZWR1bGVkVmFsdWVzKHRpbWUpO1xuICAgIHRoaXMuX19nYWluTm9kZS5nYWluLnNldFZhbHVlQXRUaW1lKHRoaXMuX19nYWluTm9kZS5nYWluLnZhbHVlLCB0aW1lKTtcbiAgICB0aGlzLl9fZ2Fpbk5vZGUuZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgwLCB0aW1lICsgdGhpcy5mYWRlVGltZSk7XG4gIH1cblxuICBnZXQgZ2FpbigpIHtcbiAgICByZXR1cm4gdGhpcy5fX2dhaW5Ob2RlLmdhaW4udmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGJ1ZmZlciBkdXJhdGlvblxuICAgKiBAdHlwZSB7TnVtYmVyfVxuICAgKiBAbmFtZSBidWZmZXJEdXJhdGlvblxuICAgKiBAbWVtYmVyb2YgUGxheWVyRW5naW5lXG4gICAqIEBpbnN0YW5jZVxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBidWZmZXJEdXJhdGlvbigpIHtcbiAgICBpZih0aGlzLmJ1ZmZlcilcbiAgICAgIHJldHVybiB0aGlzLmJ1ZmZlci5kdXJhdGlvbjtcblxuICAgIHJldHVybiAwO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBsYXllckVuZ2luZTtcbiJdfQ==